name: Project CI (Backend + Frontend + ML)

on:
  push:
    paths:
      - "SE_project/**"
      - ".github/workflows/project-ci.yml"

  pull_request:
    paths:
      - "SE_project/**"
      - ".github/workflows/project-ci.yml"

jobs:
  ci:
    runs-on: windows-latest

    steps:
    # -------------------------------------------------
    # 1. Checkout repository
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------
    # 2. Setup Python
    # -------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    # -------------------------------------------------
    # 3. Install Backend Dependencies
    # -------------------------------------------------
    - name: Install backend dependencies
      run: |
        cd backend
        if (Test-Path requirements.txt) {
            pip install -r requirements.txt
        } else {
            Write-Output "No backend requirements.txt found."
        }

    # -------------------------------------------------
    # 4. Install Frontend Dependencies
    # -------------------------------------------------
    - name: Install frontend dependencies
      run: |
        pip install streamlit

    # -------------------------------------------------
    # 5. Install ML Dependencies (if any)
    # -------------------------------------------------
    - name: Install ML dependencies
      run: |
        if (Test-Path "ml/requirements.txt") {
            pip install -r ml/requirements.txt
        } else {
            Write-Output "No ML requirements.txt found."
        }

    # -------------------------------------------------
    # 6. Lint Entire Project
    # -------------------------------------------------
    - name: Run flake8 linting
      run: |
        pip install flake8
        flake8 . --exclude __pycache__

    # -------------------------------------------------
    # 7. Run Tests
    # -------------------------------------------------
    - name: Run pytest tests
      run: |
        pip install pytest pytest-cov flake8
        pytest tests/ -v --cov=backend --cov-report=term-missing

    # -------------------------------------------------
    # 8. Backend Health Check
    # -------------------------------------------------
    - name: Backend health check
      run: |
        cd backend
        python app.py --help

    # -------------------------------------------------
    # 9. Streamlit Health Check
    # -------------------------------------------------
    - name: Streamlit check
      run: |
        streamlit --version

    # -------------------------------------------------
    # 10. Create build artifact
    # -------------------------------------------------
    - name: Create build artifact
      run: |
        powershell Compress-Archive -Path . -DestinationPath project-build.zip

    # -------------------------------------------------
    # 11. Upload build artifact
    # -------------------------------------------------
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: full-project-build
        path: project-build.zip
